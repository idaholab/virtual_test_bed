# Multiphysics Models

*Point of Contact: Yinbin Miao (ymiao.at.anl.gov)*

*Primary Contributors: Nicholas Fassino, Yinbin Miao, Kun Mo, Nicolas Stauff*

*Model link: [HPMR Model](https://github.com/idaholab/virtual_test_bed/tree/main/microreactors/mrad)*

!alert note title=Acknowledgement
This HP-MR model was built upon earlier work performed under ARPA-E MEITNER project and reported in the journal paper [!citep](matthews2021coupled), and some parts of the inputs are coming from these original models. The TRISO failure analysis BISON input files were adapted from inputs available in the BISON repository and reported in [!citep](bison_triso_model).

## TRISO Failure Model Description

The HP-MR TRISO fuel particle model used in this exercise is a one-dimensional simplification of the model detailed in [!citep](Stauff2021). The model is separated into two component inputs: (1) a main particle model and (2) a parent application input that employs the MOOSE MultiApp functionality and the Samplers system to sample a user-specified number of simulations of the particle model. Particle layer widths are provided in the parent input file, which converts them to normal distributions with user-provided standard deviations and bounds. Upon each execution of the particle simulation, these geometry distributions are sampled, and a set of layer coordinates is passed to the particle simulation with the Samplers system. Following the particle simulation, layer failure data are extracted from the particle simulation with the Transfers system. This information includes, for example, binary flags for multiple failure modes, the maximum neutron fluence in the particle, and fluence at failure (if applicable). The failure rate of the particle due to several mechanisms is then reported with VectorPostprocessors that track the stochastic results of the simulation.

The  HP-MR TRISO model, documented in ANL/NEAMS-21/3 [!citep](Stauff2021), received a number of changes for this work. First, the fission rate, fuel exterior temperature, and hydrostatic pressure of the particle are time-dependent quantities retrieved from outputs of the HP-MR multiphysics simulation. Fission rate is calculated within each particle simulation with a volume integral of the power density, using a fuel kernel volume that varies for each simulation due to the statistical sampling of the fuel kernel radius. Second, in accordance with the modeling approach taken by [!citep](bison_triso_model), a Terminator UserObject is implemented to end the simulation early if the SiC layer is determined to have failed. This is because the TRISO fuel particle is considered to have undergone failure if the SiC layer fails, as fission gases can no longer be retained within the particle layers. Finally, also proposed by [!citep](bison_triso_model), several TRISOStressCorrelationFunction and ConstantFunction objects have been implemented to describe the effects of multi-dimensional particle phenomena on layers stresses in a one-dimensional simulation. 

## HP-MR TRISO Multi-Dimensional Stress Correlation

For computational efficiency, a one-dimensional TRISO particle model is used for the Monte Carlo sampling scheme. However, multi-dimensional TRISO phenomena, such as particle cracking and asphericity, must be described with higher-order modeling approaches. To account for these phenomena, a suite of preliminary one-dimensional (1D) and two-dimensional (2D) TRISO particle simulations were performed with statistical variations of the inner-pyrolytic carbon (IPyC), outer-pyrolytic carbon (OPyC), and silicon carbide (SiC) layer thicknesses in two 2D scenarios: (1) a prescribed radial crack in the IPyC layer generated with the extended finite element method and (2) an aspherical TRISO particle generated by applying an aspect ratio of 1.04 to the particle mesh.  The resulting maximum stresses observed in each particle layer in these 1D and 2D simulations are then used to construct correlation functions describing the effects of these phenomena on layer stresses. For the aspherical particle, the changes in stress in the 1D and 2D simulations are also used for the generation of these correlation functions. These values are applied to one-dimensional particle simulations with the TRISOStressCorrelationFunction Function object, which calls for polynomial stress correlation function coefficients, correlation factors, and changes in stress. The stress correlation function objects are shown below.
The reader is encouraged to consult [!citep](bison_triso_model) for further detail on the generation of these multi-dimensional stress correlation functions used in 1-D TRISO simulations.

!listing /mrad/triso_failure/TRISO/triso_particle.i block=Functions/high_fidelity_strength_crackedIPyC 

!listing /mrad/triso_failure/TRISO/triso_particle.i block=Functions/stress_correlation_crackedIPyC 

!listing /mrad/triso_failure/TRISO/triso_particle.i block=Functions/high_fidelity_strength_asphericity 

!listing /mrad/triso_failure/TRISO/triso_particle.i block=Functions/stress_correlation_asphericity 

!listing /mrad/triso_failure/TRISO/triso_particle.i block=Functions/stress_change_correlation_asphericity 

## HP-MR TRISO MultiApps Model Setup

MOOSE-based TRISO failure analysis in this demonstration is conducted with two BISON inputs in a MultiApps setup: (1) a TRISO sampler input serving as the parent BISON app and (2) a TRISO particle input as the sub-app.

### TRISO Sampler

As stated previously, a master input employs the MOOSE MultiApp functionality and the Samplers system to sample a user-specified number of simulations of the particle model. Particle layer widths are provided in this master input file in the form of normal distributions with mean values, standard deviations, and bounds. These quantities are listed in [table:triso_geom].

!table id=table:triso_geom caption=HP-MR TRISO Geometries
| Parameter                                       | Values |
|-------------------------------------------------|--------|
| Kernel radius ($\mathrm{\mu}$m)                 | 212.5  |
| Kernel standard deviation ($\mathrm{\mu}$m)     | 4.4    |
| Buffer thickness ($\mathrm{\mu}$m)              | 100    |
| Buffer standard deviation ($\mathrm{\mu}$m)     | 8.4    |
| IPyC/OPyC thickness ($\mathrm{\mu}$m)           | 40     |
| IPyC standard deviation ($\mathrm{\mu}$m)       | 2.5    |
| OPyC standard deviation ($\mathrm{\mu}$m)       | 2.9    |
| SiC thickness ($\mathrm{\mu}$m)                 | 35     |
| SiC standard deviation ($\mathrm{\mu}$m)        | 1.2    |

These distributions are sampled and passed to the TRISO particle simulation with MultiApps and Transfers objects. After the simulation, particle failure data are passed back to the master app with Transfers. Failure data for each particle simulation is calculated with Postprocessors in each simulation, and transferred to VectorPostprocessors defined in the master app.

In previous work, the multiphysics unit-cell HP-MR model was discretized into 32 axial segments, serving as a a straightforward axial discretization of TRISO layer failure rates within the unit-cell. Therefore, the TRISO sampler master app is configured to instantiate and sample simulations of 32 TRISO particles, whose boundary conditions are retrieved from axially discretized data. Thus, the TRISO_sampler.i input contains 32 objects for every class required in the MultiApps setup, including MultiApps, Controls, Outputs, Transfers, and VectorPostprocessors objects. A Transfer and corresponding VectorPostprocessor object is required for the retrieval and subsequent storage of every requested output quantity from a single particle simulation. These quantites include the following:
- Overall SiC failure (binary indicator)
- Overall IPyC cracking (binary indicator)
- Debonding (binary indicator)
- SiC failure due to overpressure (binary indicator)
- SiC failure due to IPyC cracking (binary indicator)
- Sampler data
- Fluence at failure
- Palladium penetration length
- Failure due to palladium penetration (binary indicator)
- Kernel migration distance
- Failure due to kernel migration (binary indicator)

Therefore, 352 VectorPostprocessor and Transfer objects are required in the TRISO_sampler.i master app: 32 for each of the 11 transferred quantities. However, though 32 particle simulations are instantiated and sampled in parallel, only one triso_particle.i input file is necessary, as these different simulations are distringuised through the use of the particle_number cli argument, which is used to select appropriate boundary condition .CSVs and produce TRISO simulation output files.

The full triso_sampler.i input is listed below.

!listing /mrad/triso_failure/TRISO/triso_sampler.i max-height = 10000


### TRISO Particle

The TRISO particle input is largely repurposed from the work done in [!citep](bison_triso_model), and available in the BISON repository at `bison/examples/TRISO/failure_probability_monte_carlo/triso_1d_function.i`. It is a one-dimensional TRISO model whose irradiation and composition parameters are provided in [table:triso_params]

!table id=table:triso_params caption=Fuel parameters used in this input file
| Parameter                           | Values |
|-------------------------------------|--------|
| Fuel Type                           | UCO |
| $^{235}$U enrichment (at.%)           | 19.55   |
| Carbon/uranium (atomic ratio)       | 0.4    |
| Oxygen/uranium (atomic ratio)       | 1.5    |
| Kernel density (g/cm$^3$)             | 10.744   |
| Buffer density (g/cm$^3$)             | 1.05   |
| IPyC density (g/cm$^3$)               | 1.882   |
| OPyC density (g/cm$^3$)               | 1.882   |
| SiC density (g/cm$^3$)               | 3.171   |
| Initial IPyC BAF                       | 1.0465   |
| Initial OPyC BAF                       | 1.0429   |
| Fast Flux  $\left(\frac{n}{m^2 s}\right)$    | $7.664 \times 10^{19}$ |

where BAF is the [Bacon anisotropy factor](https://mooseframework.inl.gov/bison/source/materials/BaconAnisotropyFactor.html), which increases with fast fluence. 

The major difference between this particle input and the reference file at `bison/examples/TRISO/failure_probability_monte_carlo/triso_1d_function.i` is the definition of the thermo-mechanical boundary conditions, namely the fuel temperature, power density, and hydrostatic stress, which are retrieved from CSV datafiles produced by the unit-cell HP-MR multiphysics simulation. Each time a triso_particle.i simulation is executed, the appropriate data is selected due to the particle_number cli_arg defined in the MultiApps object that instantiates the simulation. The power density function is used in conjunction with an InternalVolume Postprocessor in a ParsedFunction to compute fission rate.


```
[Functions]
  [pressure_function]
    type=PiecewiseLinear
    format=columns
    data_file=${raw '../UnitCell_with_TM/fuelsample/pressuredata ${particle_number} .csv'}
  []
  [pdens_function]
    type=PiecewiseLinear
    format=columns
    data_file=${raw '../UnitCell_with_TM/fuelsample/powdata ${particle_number} .csv'}
  []
  [temperature_function]
    type=PiecewiseLinear
    format=columns
    data_file=${raw '../UnitCell_with_TM/fuelsample/tempdata ${particle_number} .csv'}
  []    
  [fission_rate]
    type=ParsedFunction
    expression = 'Pdens * PackingFraction * Vol / Jfiss'
    symbol_names = 'Pdens PackingFraction Vol Jfiss'
    symbol_values = 'pdens_function 0.4 kernel_volume 3.2e-11'
  [] 
  ...
[]
```


Temperature and pressure are then applied as boundary conditions (BCs) with the FunctionDirichletBC and Pressure boundary condition objects, respectively.

```
[BCs]
  ...
  [freesurf_temp]
    type = FunctionDirichletBC
    variable = temperature
    function = temperature_function
    boundary = exterior
  []
  [exterior_pressure_x]
    type = Pressure
    variable = disp_x
    boundary = exterior
    function = pressure_function
  [] 
  ...
[]
```

The full triso_particle.i input is listed below.

!listing /mrad/triso_failure/TRISO/triso_particle.i max-height = 10000


## HP-MR Unit-Cell Multiphysics Simulation

The HP-MR multiphysics modeling setup is similar to the [full-core model multiphysics setup](https://mooseframework.inl.gov/virtual_test_bed/microreactors/mrad/mrad_model.html).

### Griffin Model

Griffin is used to govern the neutronics of the HP-MR as the parent application of the multiphysics simulation. A Monte Carlo Serpent-2 model has been setup to simulate the double heterogeneity of the HP-MR full core explicitly with the most recent ENDF/B-8.0 cross section data sets. This Monte Carlo model is used not only to provide reference solutions to the Griffin neutronics model for multiphysics simulations, but also to generate condensed multigroup cross sections for Griffin. In particular, multigroup cross sections were generated for each material zone by tallying the average reaction rates and group fluxes within that material region in Serpent-2 criticality calculations. Different sets of cross sections were prepared with fuel and moderator temperatures ($T_f$ and $T_m$) assumed at 600 K, 700 K, 800 K, 1000 K and 1200 K respectively. These cross-section sets were then read by the ISOXML utility module in Griffin to create a bi-dimension cross section table which was used in the multiphysics coupled transient simulations. The DFEM-SN(1,3) neutronics solver with CMFD acceleration in Griffin is used in this model.

!listing /mrad/triso_failure/UnitCell_with_TM/Exec_MP_ss_griffin.i max-height = 10000

### BISON Model -- Thermal Physics

BISON is used to simulate thermal physics of the HP-MR unit-cell a child application, as it is equipped with a comprehensive set of thermophysical properties of relevant nuclear materials, especially the TRISO-loaded graphite and 316SS. As the heat pipe behavior is simulated by Sockeye, the heat pipe blocks are removed from the mesh used by BISON. The thermal behavior of the rest of the HP-MR core is dominated by heat conduction. Convective boundary conditions were defined at the top and bottom of the model with an external temperature of 800 K and a heat transfer coefficient (HTC) of 100 W/m^2^•K.

This stage of the simulation is where temperature, power density, and hydrostatic stress data are reported in the /fuelsample subdirectory for use by the TRISO failure analysis BISON inputs. A single CSV output file is reported for each variable at each axial block, resulting in 96 CSV output files. These files are updated with a new row for every completed timestep.

!listing /mrad/triso_failure/UnitCell_with_TM/MP_ss_sockeye.i max-height = 10000

### Sockeye Model

For the central heat pipe in the HP-MR unit-cell model, a Sockeye grandchild application is used to calculate its thermal performance. The effective thermal conductivity model, i.e., a 2D axisymmetric conduction model with a very high thermal conductivity of 2×10^5^ W/m•K is applied to the vapor core. A heat flux boundary condition is applied to the exterior of the casing in the evaporator section, which is provided by the bulk conduction model. A convective boundary condition is applied to the exterior of the envelope in the condenser section, with an external temperature of 800 K and a heat transfer coefficient (HTC) of 10^6^ W/m^2^•K (the value is intentionally set high to achieve an effective Dirichlet boundary condition).

!listing /mrad/triso_failure/UnitCell_with_TM/MP_ss_bison.i max-height = 10000

### BISON Model -- Tensor Mechanics

An original BISON grandchild application is used to calculate the tensor mechanics of the HP-MR unit-cell. This application receives temperature from the BISON thermal physics sub-app, uses it to compute block displacements, stresses, and strains of the fuel, moderator, monolith, stainless steel envelope, and axial reflector blocks. The displacement variables are then transferred back to the BISON app. Hydrostatic stresses are also transferred to the BISON sub-app so that hydrostatic stress, temperature, and power density are all reported by the BISON sub-app at the end of the simulation. Dirichlet boundary conditions are applied to the bottom surface of the unit-cell, fixing displacement in all directions. 

!listing /mrad/triso_failure/UnitCell_with_TM/MP_ss_bison_TM.i max-height = 10000

### MultiApps Hierarchy

The four MOOSE applications that govern different physics respectively are coupled together leveraging the MOOSE MultiApps system. Each code has its own mesh and corresponding space and time scales. The MOOSE MultiApp system is used to tightly couple the different codes via fixed point iterations as illustrated below in [hpmr_multiapps]. This method is largely unchanged from that reported in the [full-core model multiphysics setup](https://mooseframework.inl.gov/virtual_test_bed/microreactors/mrad/mrad_model.html), with the major addition being the BISON tensor mechanics grandchild app.

At the top level, Griffin calculates the power density based on its neutronics results given the fuel and moderator temperatures taken from the BISON child application. The calculated power density is also provided to BISON to update the temperature calculation. On the other hand, for the surface of each heat pipe, the thermal-physics BISON sub-app calculates the layered average heat flux along the normal direction of the surface and transfers the 1D field values to the respective Sockeye sub-application so that Sockeye can use them as its boundary condition. Meanwhile, the thermal-physics BISON sub-app takes the heat pipe surface temperature calculated by Sockeye back for its own boundary condition on the heat pipe surface. Additionally, the thermal-physics BISON sub-app transfers the nodal temperature variable to the tensor mechanics BISON grandchild app, which calculates material stresses, strains, and displacements, and transfers the displacement variables and fuel hydrostatic stresses back to the thermal-physics BISON sub-app.

!media unitcell_multiapps.png
       style=display: block;margin-left:auto;margin-right:auto;width:70%;
       id=hpmr_multiapps
       caption=MultiApps hierarchy of the HP-MR multiphysics simulations.

### Multiphysics Simulation Results

The results of the multiphysics simulation are the 96 CSV files that describe the time-varying temperature, power density, and hydrostatic stress of the HP-MR fuel at each of the 32 axial blocks. These files are produced in the /fuelsample subdirectory that appears in the directory where the multiphysics simulation is executed.

## Simulation Cases

Whereas the [full-core model model](https://mooseframework.inl.gov/virtual_test_bed/microreactors/mrad/mrad_model.html) presented three different HP-MR scenarios: steady-state operation, load-following transient, and heat pipe failure transient; only steady-state operation of the HP-MR unit cell is reported in this model. This is because the load-following transient does not significantly affect the failure rates of the HP-MR TRISO fuel particle [!citep](stauff2023multiphysics)

### Steady State Operation

For steady state simulation, the Griffin parent application performs an Eigenvalue calculation with a fixed preset integrated power (1.8 kW) to compute $k_{eff}$ as well as the shape of power distribution. In the meantime, the BISON child application works with the Sockeye and BISON grandchild sub-applications to perform transient thermo-mechanical calculations using the given power density distribution until a thermal equilibrium is achieved. Once the fixed point iteration between different levels of MultiApps is converged, the steady state operation condition of the HP-MR at the given power level is obtained.

## Model Meshes

### HP-MR Unit Cell 

Mesh generation with MOOSE's intrinsic mesh generator set has been the subject of extensive development, and is demonstrated in the [HP-MR full core model](https://mooseframework.inl.gov/virtual_test_bed/microreactors/mrad/mrad_model.html). This work, however, is a streamlined continuation of work documented in ANL/NEAMS-21/3 [!citep](Stauff2021), which employed python scripts to generate the The HP-MR unit-cell mesh. The HP-MR unit-cell model and mesh are not the main focus of this demonstration. Thus, mesh generation of the unit-cell has not been updated to use MOOSE mesh generators. The reader is encouraged to peruse the [HP-MR full core model documentation](https://mooseframework.inl.gov/virtual_test_bed/microreactors/mrad/mrad_model.html) for a demonstration of the MOOSE mesh generators and Reactor module to generate HP-MR meshes. 

### HP-MR TRISO

The TRISO particle mesh is built with the [TRISO1DFiveLayerMeshGenerator](https://mooseframework.inl.gov/bison/source/meshgenerators/TRISO1DFiveLayerMeshGenerator.html) mesh generator object, which creates a 1D mesh with five material blocks, automatically named "fuel", "buffer", "IPyC", "SiC", and "OPyC."

## Guidance of Running Different Simulation Cases

To completely run this model, the user only needs to execute two inputs: the Griffin input for the unit-cell multiphysics model, which is the master app that governs the entire simulation, then the sampler BISON input for the TRISO failure analysis calculation. As discussed previously, the multiphysics steady state HP-MR simulation uses Griffin, BISON and Sockeye objects. Therefore, users should use a super application that covers these three applications, such as DireWolf or BlueCRAB (compiled with Sockeye included). The example command to run the unit-cell HP-MR multiphyiscs simulation is shown as follows, considering an mpi run with 40 CPUs:

!listing language=bash
cd /mrad/triso_failure/UnitCell_with_TM
mpirun -n 40 dire_wolf-opt -i Exec_MP_ss_griffin.i

This multiphysics simulation will produce the fuel temperature, power density, and hydrostatic stress CSV files that the TRISO failure analysis calculation uses as boundary conditions and will store them in the generated /fuelsample subdirectory. Once this simulation is complete, the user can then simply execute the TRISO sampler input with BISON, again assuming 40 CPUs:

!listing language=bash
cd /mrad/triso_failure/TRISO
mpirun -n 40 bison-opt -i triso_sampler.i

The TRISO failure analysis simulation will produce particle failure rate output in the /results subdirectory. All output will be written at the conclusion of the simulation. Each of the 32 axially-discretized particle simulations will receive its own output subdirectory in /results/particle(number). The provided plots.py will produce plots of axially discretized SiC and IPyC layer failure rates. 

The user may vary the integrated power or temperature in the multiphysics simulation, and the number of sampled particles in the TRISO sampler simulation, to explore how these quantities affect TRISO layer failure rates. The user may also modify these inputs to forego the calculation of tensor mechanics in the unit-cell to observe how the consideration of hydrostatic stresses affects results.
